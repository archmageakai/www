<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
	
    <title>ギコっぽいの赤いネス</title>
    
    <script>
let jsonData = {};
let itemsData = {};
let bladesData = {};
let lastLoadedPlayer = ""; // Cache to track current displayed player
let lastJsonData = ""; // Cache to prevent unnecessary updates

// Function to load JSON data and update player display
async function loadJSON() {
    try {
        const userResponse = await fetch('users.json', { cache: 'no-store' });
        const newJsonData = await userResponse.text(); // Read as text first to compare
        if (newJsonData === lastJsonData) return; // Skip reload if data is unchanged
        lastJsonData = newJsonData; // Update cache
        jsonData = JSON.parse(newJsonData); // Parse new data

        const itemsResponse = await fetch('items.json', { cache: 'no-store' });
        itemsData = await itemsResponse.json();

        const bladesResponse = await fetch('blade.json', { cache: 'no-store' });
        bladesData = await bladesResponse.json();

        updatePlayerData(); // Update display only when data changes
    } catch (error) {
        console.error('Error loading JSON:', error);
    }
}

// Function to format numbers
function formatNumber(value) {
    return (typeof value === 'number' && !Number.isInteger(value)) ? value.toFixed(2) : value.toString();
}

// Get item name by ID
function getItemName(itemID) {
    const item = itemsData.items.find(i => i.item_ID === itemID);
    return item ? item.item_name : "Unknown Item";
}

// Get blade name by ID
function getBladeName(bladeID) {
    const blade = bladesData.blades.find(b => b.blade_ID === bladeID);
    return blade ? blade.blade_name : "Unknown Blade";
}

// Function to update player data
function updatePlayerData() {
    let resultDiv = document.getElementById("result");
    
    if (!jsonData || !jsonData.users) {
        resultDiv.innerHTML = "<p>Loading. . .</p>";
        return;
    }

    // Get player name from URL hash (e.g., #Moon)
    let playerName = decodeURIComponent(window.location.hash.slice(1)).trim();
    if (!playerName || playerName === lastLoadedPlayer) return; // Skip redundant updates

    let player = jsonData.users.find(user => user.player_name === playerName);

    if (player) {
        lastLoadedPlayer = playerName; // Cache the loaded player name

        let yen = formatNumber(player.currencies.yen);
        let grossYen = formatNumber(player.currencies.gross_yen);
        let todayGacha = formatNumber(player.gacha.today);
        let guaranteeGacha = formatNumber(player.gacha.guarantee);
        let totalGacha = formatNumber(player.gacha.total);

        resultDiv.innerHTML = `<h1>${player.player_name}</h1>`;
        resultDiv.innerHTML += `<u><strong>Gacha</strong></u>`;
        resultDiv.innerHTML += `<p>Today: ${todayGacha} / Guarantee: ${guaranteeGacha} / Total: ${totalGacha}</p>`;

        // Display Items
        resultDiv.innerHTML += `<u><strong>Inventory</strong></u>`;
        if (Object.keys(player.items).length > 0) {
            let itemIndex = 1;
            Object.entries(player.items).forEach(([key, value]) => {
                let itemName = getItemName(parseFloat(key));
                resultDiv.innerHTML += `<p>${itemIndex}. [ID ${key}] <a href="testitems.html#${key}">${itemName}</a> x ${value}</p>`;
                itemIndex++;
            });
        } else {
            resultDiv.innerHTML += `<p>No items</p>`;
        }

        // Display Blades
        resultDiv.innerHTML += `<u><strong>Blades</strong></u>`;
        if (Object.keys(player.blades).length > 0) {
            let bladeIndex = 1;
            Object.entries(player.blades).forEach(([key, value]) => {
                let bladeName = getBladeName(parseFloat(key));
                resultDiv.innerHTML += `<p>${bladeIndex}. [ID ${key}] <a href="testblades.html#${key}">${bladeName}</a> <br>
                    Slots (Available: ${value.core_slots.available}, Used: ${value.core_slots.used}, Broken: ${value.core_slots.broken})</p>`;
                bladeIndex++;
            });
        } else {
            resultDiv.innerHTML += `<p>No blades</p>`;
        }
    } else {
        resultDiv.innerHTML = `<p>Player not found</p>`;
    }
}

// Detect hash change (user switches to another player)
window.onhashchange = updatePlayerData;

// Initial Load
window.onload = function () {
    loadJSON(); // Load initial data
    updatePlayerData(); // Load player if hash exists
};

// Refresh JSON every second without unnecessary clearing
setInterval(loadJSON, 1000);

    </script>

</head>
<body>
    <strong>Player index</strong><br>
</body>
</html>