<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
	
    <title>ギコっぽいの赤いネス</title>
    <style>
        /* FOR TESTING PURPOSES */
        /* AKAI CSS */
        body {
            color: #ff0000;
            background-color: #000000;
            font-family: "Lucida Console", "Courier New", monospace;
            line-height: 1.5;
            margin: 0;
            padding: 1rem;
            max-width: 700px;
        }

        p, center, main {
            font-size: 13px;
        }

        .content {  
            margin-bottom: 2rem;  
        }  

        .navbar {
            display: flex;  
            align-items: center;  
        } 

        header {
            border-top: 1px solid #ff0000;
            border-bottom: 1px solid #ff0000;
        }

        footer {
            border-top: 1px solid #ff0000;
            margin-top: 1rem;
        }

        a {
            color: #800000;
            text-decoration: none;
        }

        hr {
            border: none;
            text-align: center;
            max-width: 700px;
            margin: 1rem auto;
        }

        hr::before {
            content: " ♡ ♡ ♡ ♡ ♡ ♡ ♡ ♡ ♡ ";
            color: #ff0000;
            letter-spacing: 3px;
            display: block;
            text-align: center;
        }
        /* END AKAI CSS SHEET */

        /* gachapon css start */
        table, th, td {
            border: 1px solid #ff0000 !important;
        }

        thead {
            background-color: #333333; /* Dark gray background */
            color: #ff0000;  /* Red text color for the header */
        }

        th {
            padding: 10px;
            text-align: left;
            vertical-align: middle;
            color: #ff0000;  /* Ensure text color is red */
        }

        /* Rest of your existing CSS */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid #ff0000;
            padding: 10px;
            text-align: left;
            vertical-align: middle;
            color: #ff0000;  /* Red text color */
        }

        /* Square image cell */
        .image-cell {
            width: 60px;  /* Set square size */
            height: 60px; 
            text-align: center;
        }

        /* Square images */
        .image-cell img {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Ensures image fits without distortion */
            display: block;
        }

        /* Rarity colors */
        .rarity5star { color: purple; font-weight: bold; }
        .rarity4star { color: gold; font-weight: bold; }
        .rarity3star { color: silver; }
        .rarity2star { color: red; }
        .rarity1star { color: red; }

        /* Highlight class */
        .highlight { background-color: maroon; }

        /* Link styles */
        .show-all-link {
            color: maroon;
            text-decoration: none;
            display: block;
            margin-top: 20px;
        }

        /* search */
        input[type="text"] {
            font-size: 16px;
            font-family: "Lucida Console", "Courier New", monospace;
            background-color: #000000;
            color: #ff0000;
            border: 1px solid #ff0000;
            padding: 10px 20px;
            width: 100%; /* Adjust width to fill the container */
            max-width: 300px; /* Keep search bar size fixed */
            height: 42px; /* Match the button height */
            box-sizing: border-box; /* Ensures padding doesn't affect size */
        }

        /* Suggestions box */
        .suggestions-box {
            background-color: #333333;
            border: 1px solid #ff0000;
            color: #ff0000;
            max-height: 200px;
            overflow-y: auto;
            position: absolute;
            width: 100%;
            max-width: 300px; /* Match search bar width */
            margin-top: 5px;
            z-index: 10;
            display: none; /* Hide suggestions initially */
        }

        /* Individual suggestion style */
        .suggestion {
            padding: 10px;
            cursor: pointer;
        }

        .suggestion:hover {
            background-color: #ff0000;
            color: #ffffff;
        }

        /* Button styling */
        button {
            font-size: 16px;
            color: #ff0000; /* Red text color */
            font-family: "Lucida Console", "Courier New", monospace;
            background-color: #333333; /* Dark gray background */
            border: 1px solid #ff0000; /* Red border */
            padding: 10px 20px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }

        button:hover {
            background-color: #ff0000; /* Red background on hover */
            color: #ffffff; /* White text on hover */
        }

        /* Active button state (when the sorting button is clicked) */
        button.active {
            background-color: #ff0000; /* Red background for active button */
            color: #ffffff; /* White text for active button */
            border: 1px solid #ff0000; /* Red border */
        }
        /* gachapon css end */
    </style>
    
    <script>
let jsonData = {};
let itemsData = {};
let bladesData = {};
let lastLoadedPlayer = ""; // Cache to track current displayed player
let lastJsonData = ""; // Cache to prevent unnecessary updates

// Function to load JSON data and update player display
async function loadJSON() {
    try {
        const userResponse = await fetch('users.json', { cache: 'no-store' });
        const newJsonData = await userResponse.text(); // Read as text first to compare
        if (newJsonData === lastJsonData) return; // Skip reload if data is unchanged
        lastJsonData = newJsonData; // Update cache
        jsonData = JSON.parse(newJsonData); // Parse new data

        const itemsResponse = await fetch('items.json', { cache: 'no-store' });
        itemsData = await itemsResponse.json();

        const bladesResponse = await fetch('blade.json', { cache: 'no-store' });
        bladesData = await bladesResponse.json();

        updatePlayerData(); // Update display only when data changes
    } catch (error) {
        console.error('Error loading JSON:', error);
    }
}

// Function to format numbers
function formatNumber(value) {
    return (typeof value === 'number' && !Number.isInteger(value)) ? value.toFixed(2) : value.toString();
}

// Get item name by ID
function getItemName(itemID) {
    const item = itemsData.items.find(i => i.item_ID === itemID);
    return item ? item.item_name : "Unknown Item";
}

// Get blade name by ID
function getBladeName(bladeID) {
    const blade = bladesData.blades.find(b => b.blade_ID === bladeID);
    return blade ? blade.blade_name : "Unknown Blade";
}

// Function to update player data
function updatePlayerData() {
    let resultDiv = document.getElementById("result");
    
    if (!jsonData || !jsonData.users) {
        resultDiv.innerHTML = "<p>Loading. . .</p>";
        return;
    }

    // Get player name from URL hash (e.g., #Moon)
    let playerName = decodeURIComponent(window.location.hash.slice(1)).trim();
    if (!playerName || playerName === lastLoadedPlayer) return; // Skip redundant updates

    let player = jsonData.users.find(user => user.player_name === playerName);

    if (player) {
        lastLoadedPlayer = playerName; // Cache the loaded player name

        let yen = formatNumber(player.currencies.yen);
        let grossYen = formatNumber(player.currencies.gross_yen);
        let todayGacha = formatNumber(player.gacha.today);
        let guaranteeGacha = formatNumber(player.gacha.guarantee);
        let totalGacha = formatNumber(player.gacha.total);

        resultDiv.innerHTML = `<h1>${player.player_name}</h1>`;
        resultDiv.innerHTML += `<u><strong>Gacha</strong></u>`;
        resultDiv.innerHTML += `<p>Today: ${todayGacha} / Guarantee: ${guaranteeGacha} / Total: ${totalGacha}</p>`;

        // Display Items
        resultDiv.innerHTML += `<u><strong>Inventory</strong></u>`;
        if (Object.keys(player.items).length > 0) {
            let itemIndex = 1;
            Object.entries(player.items).forEach(([key, value]) => {
                let itemName = getItemName(parseFloat(key));
                resultDiv.innerHTML += `<p>${itemIndex}. [ID ${key}] <a href="testitems.html#${key}">${itemName}</a> x ${value}</p>`;
                itemIndex++;
            });
        } else {
            resultDiv.innerHTML += `<p>No items</p>`;
        }

        // Display Blades
        resultDiv.innerHTML += `<u><strong>Blades</strong></u>`;
        if (Object.keys(player.blades).length > 0) {
            let bladeIndex = 1;
            Object.entries(player.blades).forEach(([key, value]) => {
                let bladeName = getBladeName(parseFloat(key));
                resultDiv.innerHTML += `<p>${bladeIndex}. [ID ${key}] <a href="testblades.html#${key}">${bladeName}</a> <br>
                    Slots (Available: ${value.core_slots.available}, Used: ${value.core_slots.used}, Broken: ${value.core_slots.broken})</p>`;
                bladeIndex++;
            });
        } else {
            resultDiv.innerHTML += `<p>No blades</p>`;
        }
    } else {
        resultDiv.innerHTML = `<p>Player not found</p>`;
    }
}

// Detect hash change (user switches to another player)
window.onhashchange = updatePlayerData;

// Initial Load
window.onload = function () {
    loadJSON(); // Load initial data
    updatePlayerData(); // Load player if hash exists
};

// Refresh JSON every second without unnecessary clearing
setInterval(loadJSON, 1000);

    </script>

</head>
<body>
    <strong>Player index</strong><br>
    <div id="result"></div>
</body>
</html>